import telebot
import requests
from datetime import datetime, timedelta
import threading
import time
import random
import json


TOKEN = "8403763339:AAEy4RWJBxXIpln7X5lws_hDyCPOm0UBkfo" 
ADMIN_USERNAME = "@wolfoldd"

bot = telebot.TeleBot(TOKEN)

# Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
PAIRS = {
    'eurusd': 'EUR/USD', 'gbpusd': 'GBP/USD', 'usdjpy': 'USD/JPY',
    'audusd': 'AUD/USD', 'usdcad': 'USD/CAD', 'gold': 'XAU/USD'
}

# Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
subscribers = set()
news_subscribers = set()
analysis_subscribers = set()  # Ù…Ø´ØªØ±ÙƒÙˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
user_positions = {}

@bot.message_handler(commands=['start'])
def start(message):
    welcome = f"""
ðŸ¤– *Ø¨ÙˆØª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙÙˆØ±ÙƒØ³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ*

ðŸ“Š *Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:*
ðŸ”¹ `/trading` - Ù‚Ø³Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…
ðŸ”¹ `/analysis` - ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†
ðŸ”¹ `/news` - Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©
ðŸ”¹ `/support` - Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ {ADMIN_USERNAME}

ðŸš€ *Ø§Ø®ØªØ± Ù‚Ø³Ù…Ùƒ Ø§Ù„Ø¢Ù†*
    """
    bot.reply_to(message, welcome, parse_mode='Markdown')

@bot.message_handler(commands=['analysis'])
def analysis_menu(message):
    text = """
ðŸ“Š *Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ*

/daily_analysis - Ø¢Ø®Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†
/subscribe_analysis - Ø§Ø´ØªØ±Ø§Ùƒ ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
/unsubscribe_analysis - Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
/analysis_status - Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§ÙƒÙƒ

*Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙŠÙØ±Ø³Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ø§Ù‹*
    """
    bot.reply_to(message, text, parse_mode='Markdown')

@bot.message_handler(commands=['daily_analysis'])
def daily_analysis(message):
    """Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†"""
    gold_analysis = get_gold_analysis()
    btc_analysis = get_btc_analysis()
    
    analysis_text = f"""
ðŸ“Š *Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ - {datetime.now().strftime('%d/%m/%Y')}*

ðŸª™ *ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ (XAU/USD):*
{gold_analysis}

â‚¿ *ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ† (BTC/USD):*
{btc_analysis}

âš ï¸ *ØªØ­Ù„ÙŠÙ„ ØªØ¹Ù„ÙŠÙ…ÙŠ - Ù„Ø§ ÙŠÙØ¹ØªØ¨Ø± ØªÙˆØµÙŠØ© Ù…Ø§Ù„ÙŠØ©*
    """
    bot.reply_to(message, analysis_text, parse_mode='Markdown')

def get_gold_analysis():
    """Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø°Ù‡Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ"""
    prices = get_gold_price()
    current_price = prices['current'] if prices else 2650.50
    
    # ØªØ­Ù„ÙŠÙ„ Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± (ØªØ¬Ø±ÙŠØ¨ÙŠ)
    if current_price > 2650:
        direction = "ðŸŸ¢ ØµØ¹ÙˆØ¯ÙŠ"
        target = f"{current_price + 15:.1f}"
        support = f"{current_price - 10:.1f}"
    elif current_price < 2620:
        direction = "ðŸ”´ Ù‡Ø¨ÙˆØ·ÙŠ"
        target = f"{current_price - 15:.1f}"
        support = f"{current_price + 10:.1f}"
    else:
        direction = "ðŸŸ¡ Ø¬Ø§Ù†Ø¨ÙŠ"
        target = f"{current_price + 8:.1f}"
        support = f"{current_price - 8:.1f}"
    
    return f"""
ðŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: `{current_price:.2f}$`
{trend_emoji(current_price)} Ø§Ù„Ø§ØªØ¬Ø§Ù‡: {direction}
ðŸŽ¯ Ø§Ù„Ù‡Ø¯Ù: {target}$
ðŸ›¡ï¸ Ø§Ù„Ø¯Ø¹Ù…: {support}$
ðŸ“ *Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª*: {random.choice(['Ù‚ÙˆØ© Ø´Ø±Ø§Ø¦ÙŠØ© Ø¹Ø§Ù„ÙŠØ©', 'Ø¶ØºØ· Ø¨ÙŠØ¹ÙŠ', 'Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªØ±Ø§Ù‚', 'Ø­Ø±ÙƒØ© Ø¬Ø§Ù†Ø¨ÙŠØ©'])}
    """

def get_btc_analysis():
    """Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØªÙƒÙˆÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ"""
    prices = get_btc_price()
    current_price = prices['current'] if prices else 98000
    
    if current_price > 100000:
        direction = "ðŸŸ¢ ØµØ¹ÙˆØ¯ÙŠ Ù‚ÙˆÙŠ"
        target = f"{current_price * 1.05:.0f}"
        support = f"{current_price * 0.97:.0f}"
    elif current_price < 90000:
        direction = "ðŸ”´ Ù‡Ø¨ÙˆØ·ÙŠ"
        target = f"{current_price * 0.95:.0f}"
        support = f"{current_price * 1.03:.0f}"
    else:
        direction = "ðŸŸ¡ ØªØ°Ø¨Ø°Ø¨"
        target = f"{current_price * 1.03:.0f}"
        support = f"{current_price * 0.97:.0f}"
    
    return f"""
ðŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: `{current_price:.0f}$`
{trend_emoji(current_price, is_btc=True)} Ø§Ù„Ø§ØªØ¬Ø§Ù‡: {direction}
ðŸŽ¯ Ø§Ù„Ù‡Ø¯Ù: {target}$
ðŸ›¡ï¸ Ø§Ù„Ø¯Ø¹Ù…: {support}$
ðŸ“ *Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª*: {random.choice(['Ø¶ØºØ· Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª', 'ØªØµØ±ÙŠØ­Ø§Øª Ø±Ø¦ÙŠØ³ ÙÙŠØ¯Ø±Ø§Ù„ÙŠ', 'Ø­Ø±ÙƒØ© ØªÙˆØ²ÙŠØ¹', 'Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø± ETF'])}
    """

def trend_emoji(price, is_btc=False):
    """Ø¥Ø±Ø¬Ø§Ø¹ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡"""
    if is_btc:
        return "ðŸš€" if price > 95000 else "ðŸ“‰" if price < 92000 else "âž¡ï¸"
    return "ðŸ“ˆ" if price > 2640 else "ðŸ“‰" if price < 2610 else "â†”ï¸"

def get_gold_price():
    """Ø¬Ù„Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ"""
    try:
        response = requests.get("https://api.metals.live/v1/spot/XAU", timeout=5)
        data = response.json()
        return {'current': float(data['price'])}
    except:
        return None

def get_btc_price():
    """Ø¬Ù„Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†"""
    try:
        response = requests.get("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd", timeout=5)
        data = response.json()
        return {'current': data['bitcoin']['usd']}
    except:
        return None

@bot.message_handler(commands=['subscribe_analysis'])
def subscribe_analysis(message):
    user_id = message.from_user.id
    analysis_subscribers.add(user_id)
    bot.reply_to(message, "ðŸ“Š âœ… ØªÙ… Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†!
ðŸ• ÙŠÙØ±Ø³Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ø§Ù‹")

@bot.message_handler(commands=['unsubscribe_analysis'])
def unsubscribe_analysis(message):
    user_id = message.from_user.id
    analysis_subscribers.discard(user_id)
    bot.reply_to(message, "ðŸ“Š âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù…Ù† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ")

@bot.message_handler(commands=['analysis_status'])
def analysis_status(message):
    user_id = message.from_user.id
    status = "âœ… Ù…Ø´ØªØ±Ùƒ" if user_id in analysis_subscribers else "âŒ ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ"
    bot.reply_to(message, f"Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ: {status}")

# ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
def send_daily_analysis():
    """Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ø§Ù‹"""
    while True:
        now = datetime.now()
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ø§Ù‹
        if now.hour == 8 and now.minute == 0:
            if analysis_subscribers:
                analysis = daily_analysis(None)  # ØªØ­Ù„ÙŠÙ„ ÙƒØ§Ù…Ù„
                for user_id in list(analysis_subscribers):
                    try:
                        bot.send_message(user_id, analysis, parse_mode='Markdown')
                    except:
                        pass
            time.sleep(3600)  # Ø§Ù†ØªØ¸Ø§Ø± Ø³Ø§Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        else:
            time.sleep(60)  # Ø§Ù„ØªØ­Ù‚Ù‚ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®ÙŠÙˆØ· ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
analysis_thread = threading.Thread(target=send_daily_analysis, daemon=True)
analysis_thread.start()

# Ø£Ù‚Ø³Ø§Ù… Ø£Ø®Ø±Ù‰ Ù…Ø®ØªØµØ±Ø© (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
@bot.message_handler(commands=['trading', 'news', 'support', 'pairs', 'price'])
def placeholder(message):
    bot.reply_to(message, "ØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…! Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙƒØ§Ù…Ù„Ø©.")

@bot.message_handler(commands=['help'])
def full_help(message):
    help_text = """
ðŸ¤– *Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:*

ðŸ“ˆ *Ø§Ù„ØªØ¯Ø§ÙˆÙ„:*
/trading - Ù‚Ø³Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„
/pairs - Ø§Ù„Ø£Ø²ÙˆØ§Ø¬
/price gold - Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ

ðŸ“Š *Ø§Ù„ØªØ­Ù„ÙŠÙ„:*
/analysis - Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„
/daily_analysis - Ø¢Ø®Ø± ØªØ­Ù„ÙŠÙ„
/subscribe_analysis - Ø§Ø´ØªØ±Ø§Ùƒ ÙŠÙˆÙ…ÙŠ

ðŸ“° *Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ø¯Ø¹Ù…:*
/news - Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
/support - Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    """
    bot.reply_to(message, help_text, parse_mode='Markdown')

if __name__ == "__main__":
    print("ðŸš€ Ø¨ÙˆØª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙÙˆØ±ÙƒØ³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ÙŠØ¹Ù…Ù„...")
    print("ðŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…ÙØ¹Ù‘Ù„ | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:", ADMIN_USERNAME)
    bot.infinity_polling()